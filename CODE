import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;

public class LibraryApp {
    
    static class Storage {
        public static final List<User> USERS = new ArrayList<>();
        public static final List<LibraryResource> RESOURCES = new ArrayList<>();
        public static final Map<Integer, DownloadOrder> DOWNLOADS = new HashMap<>();
        
        private Storage() {}
        
        public static void addResource(LibraryResource resource) {
            RESOURCES.add(resource);
            System.out.println("Storage: Resource ID " + resource.getId() + " added to global storage.");
        }
        
        public static void addUser(User user) {
            USERS.add(user);
            System.out.println("Storage: User ID " + user.getId() + " added to global storage.");
        }
    }

    static class EntityFactory {
        private static int nextUserId = 1000;
        private static int nextResourceId = 2000;
        private static int nextDownloadId = 3000;

        private EntityFactory() {}

        public static User createUser(String firstName, String lastName, String login, String password) {
            User newUser = new User(nextUserId++, firstName, lastName, login, password);
            Storage.addUser(newUser);
            return newUser;
        }

        public static Admin createAdmin(String firstName, String lastName, String login, String password) {
            Admin newAdmin = new Admin(nextUserId++, firstName, lastName, login, password);
            Storage.addUser(newAdmin);
            return newAdmin;
        }

        public static Book createBook(String title, String author, int year, String fileLink) {
            Book newBook = new Book(nextResourceId++, title, author, year, fileLink);
            Storage.addResource(newBook);
            return newBook;
        }

        public static DownloadOrder createDownloadOrder(User user, LibraryResource resource) {
            DownloadOrder newOrder = new DownloadOrder(nextDownloadId++, user.getId(), resource.getId());
            Storage.DOWNLOADS.put(newOrder.getId(), newOrder);
            return newOrder;
        }
    }

    static abstract class BaseEntity {
        protected int id;
        
        public BaseEntity(int id) {
            this.id = id;
        }

        public static int getCount(List<?> collection) {
            System.out.println("BaseEntity static method: getCount - called.");
            return collection.size();
        }
        
        public void displayInfo() {
            System.out.println("BaseEntity: Displaying info for ID " + id);
        }

        public int getId() {
            return this.id;
        }
    }

    static abstract class SystemUser extends BaseEntity {
        protected String login;
        protected String role;

        public SystemUser(int id, String login, String role) {
            super(id);
            this.login = login;
            this.role = role;
        }
        
        public static void logSystemAccess(String userLogin) {
            System.out.println("SystemUser static method: logSystemAccess - User " + userLogin + " accessed the system.");
        }

        public boolean authenticate(String password) {
            System.out.println(this.getClass().getSimpleName() + " method: authenticate - Needs password check.");
            return true;
        }

        @Override
        public void displayInfo() {
            System.out.println("SystemUser: ID " + id + ", Login: " + login + ", Role: " + role);
        }
    }
    
    static class User extends SystemUser {
        
        static class NameInfo {
            private String firstName;
            private String lastName;

            public NameInfo(String firstName, String lastName) {
                this.firstName = firstName;
                this.lastName = lastName;
            }

            @Override
            public String toString() {
                return firstName + " " + lastName;
            }
        }
        
        private NameInfo nameInfo;
        private String hashedPassword;

        public User(int userId, String firstName, String lastName, String login, String password) {
            super(userId, login, "звичайний користувач");
            this.nameInfo = new NameInfo(firstName, lastName);
            this.hashedPassword = String.valueOf(Objects.hash(password));
        }
        
        public boolean login(String password) {
            SystemUser.logSystemAccess(login);
            System.out.println("User method: login - Login attempt for " + login);
            return super.authenticate(password);
        }

        public String getFullName() {return nameInfo.toString();}
        public String getRole() {return role;}
        
        boolean checkAccessRole(String requiredRole) {
            return this.role.equals(requiredRole);
        }

        @Override
        public void displayInfo() {
            System.out.println("User: " + getFullName() + ", Role: " + role);
        }
    }

    static class Admin extends User {
        private List<String> actionsLog;

        public Admin(int adminId, String firstName, String lastName, String login, String password) {
            super(adminId, firstName, lastName, login, password);
            this.role = "адміністратор";
            this.actionsLog = new ArrayList<>();
        }

        public boolean depositBook(LibraryResource resource, LibraryCatalog catalog) {
            if (!catalog.isResourceInCatalog(resource.getId())) {
                catalog.internalAddResource(resource); 
                this.actionsLog.add("Додано ресурс ID: " + resource.getId());
                return true;
            }
            return false;
        }

        @Override
        public void displayInfo() {
            System.out.println("ADMIN: " + getFullName() + ", Log count: " + actionsLog.size());
        }
    }

    static abstract class LibraryResource extends BaseEntity {
        protected String title;
        protected String author;

        public LibraryResource(int id, String title, String author) {
            super(id);
            this.title = title;
            this.author = author;
        }

        public String getTitle() {return title;}
        public String getAuthor() {return author;}
    }
    
    static class Book extends LibraryResource {
        private int year;
        private String fileLink;
        private boolean isAvailable;

        public Book(int id, String title, String author, int year, String fileLink) {
            super(id, title, author);
            this.year = year;
            this.fileLink = fileLink;
            this.isAvailable = true;
        }

        public boolean isAvailable() {return isAvailable;}
        public void setFileLink(String fileLink) {this.fileLink = fileLink;}

        void setAvailability(boolean status) {
            this.isAvailable = status;
        }

        @Override
        public void displayInfo() {
            System.out.println("Book: Title: " + title + ", Author: " + author + ", Year: " + year + ", Available: " + isAvailable);
        }
    }
    
    static class AudioBook extends LibraryResource {
        private int durationSeconds;
        
        public AudioBook(int id, String title, String author, int durationSeconds) {
            super(id, title, author);
            this.durationSeconds = durationSeconds;
        }

        @Override
        public void displayInfo() {
            System.out.println("AudioBook: Title: " + title + ", Duration: " + durationSeconds / 60 + " min.");
        }
    }

    static class LibraryCatalog {
        private List<LibraryResource> resources;
        private String catalogName;

        public LibraryCatalog(String catalogName) {
            this.catalogName = catalogName;
            this.resources = new ArrayList<>();
        }

        public int getTotalResourceCount() {return resources.size();}
        public boolean isResourceInCatalog(int resourceId) {return resources.stream().anyMatch(r -> r.getId() == resourceId);}

        void internalAddResource(LibraryResource resource) {
            this.resources.add(resource);
        }
        
        @Override
        public String toString() {
            return "LibraryCatalog [Name=" + catalogName + ", Total Resources=" + resources.size() + "]";
        }
    }

    static class DownloadOrder extends BaseEntity {
        private int userId;
        private int resourceId;
        private LocalDateTime downloadDateTime;

        public DownloadOrder(int downloadId, int userId, int resourceId) {
            super(downloadId);
            this.userId = userId;
            this.resourceId = resourceId;
        }
        
        public boolean processDownload(User user, Book book) {
            if (!book.isAvailable()) {
                System.out.println(" Помилка: Книга недоступна для завантаження.");
                return false;
            }
            
            this.userId = user.getId();
            this.resourceId = book.getId();
            this.downloadDateTime = LocalDateTime.now();
            book.setAvailability(false); 
            
            System.out.println(" Завантаження ресурсу ID " + book.getId() + " успішне!");
            return true;
        }

        @Override
        public String toString() {
            return "DownloadOrder [ID=" + id + ", User ID=" + userId + ", Resource ID=" + resourceId + ", Time=" + downloadDateTime + "]";
        }
    }
    
    static class Category {
        private int categoryId;
        private String name;
        private List<Integer> resourceIds;

        public Category(int categoryId, String name) {
            this.categoryId = categoryId;
            this.name = name;
            this.resourceIds = new ArrayList<>();
        }

        public void assignResource(int resourceId) {
            if (!resourceIds.contains(resourceId)) {
                resourceIds.add(resourceId);
            }
        }
        
        @Override
        public String toString() {
            return "Category [ID=" + categoryId + ", Name='" + name + "', Resources=" + resourceIds.size() + "]";
        }
    }

    public static void main(String[] args) {
        System.out.println("--- ПР 3, 4 & 5: Комплексна демонстрація ---");

        System.out.println("\n>>> 1. Створення об'єктів через статичну Фабрику та збереження у Статичному Сховищі:");
        
        User standardUser = EntityFactory.createUser("Олена", "Іваненко", "olena_i", "pass123");
        Admin libraryAdmin = EntityFactory.createAdmin("Петро", "Сидоренко", "admin_p", "root");
        
        Book book1 = EntityFactory.createBook("Java. Ефективне програмування", "Джошуа Блох", 2019, "/files/java.pdf");
        Book book2 = EntityFactory.createBook("Алгоритми та структури даних", "Ніклаус Вірт", 1976, "/files/wirth.pdf");
        
        LibraryCatalog mainCatalog = new LibraryCatalog("Центральний Каталог");
        mainCatalog.internalAddResource(book1);
        mainCatalog.internalAddResource(book2);
        
        DownloadOrder order1 = EntityFactory.createDownloadOrder(standardUser, book1);

        System.out.println("\n>>> 2. Демонстрація статичних полів та методів:");
        
        int userCount = BaseEntity.getCount(Storage.USERS);
        int resourceCount = BaseEntity.getCount(Storage.RESOURCES);
        System.out.println("Кількість користувачів (зі Storage): " + userCount);
        System.out.println("Кількість ресурсів (зі Storage): " + resourceCount);
        SystemUser.logSystemAccess(standardUser.login);
        
        System.out.println("\n>>> 3. Демонстрація наслідування та перевизначення (Override):");
        
        standardUser.displayInfo();
        libraryAdmin.displayInfo();
        book1.displayInfo();
        
        System.out.println("----------------------------------------");
        
        System.out.println(">>> 4. Демонстрація package-private та інкапсуляції:");
        
        System.out.println("Доступність Book1 ДО завантаження: " + book1.isAvailable());
        
        standardUser.login("pass123");
        order1.processDownload(standardUser, book1);
        
        System.out.println("Доступність Book1 ПІСЛЯ завантаження: " + book1.isAvailable());

        System.out.println("\n--- Завершення роботи ---");
    }
}
